---
title: "hcpd_analysia"
output: html_document
date: "2024-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(broom)
library(tidyr)
library(purrr)
library(broom)
```

```{r}
# Read in the data
metrics = read.csv("~/Desktop/macedo_tract/outputs/metrics_df.csv")
main_metrics <- c('ad', 'area_of_end_region_1_mm2', 'area_of_end_region_2_mm2',
       'branch_volume_mm3', 'curl', 'diameter_mm', 'dti_fa', 'elongation',
       'gfa', 'ha', 'irregularity', 'irregularity_of_end_region_1',
       'irregularity_of_end_region_2', 'md', 'mean_length_mm',
       'nrdi06L', 'number_of_tracts', 'qa',
       'radius_of_end_region_1_mm', 'radius_of_end_region_2_mm', 'rd',
       'rdi', 'span_mm',
       'total_radius_of_end_regions_mm', 'total_surface_area_mm2',
       'trunk_volume_mm3', 'txx', 'txy', 'txz', 'tyy', 'tyz', 'tzz',
       'volume_mm3')
```

```{r}
# Clean the data, remove NANs and scale regression variables
cleaned_metrics <- metrics %>%
  drop_na(score, sex, interview_age, t1_neighbor_corr, brain_size)

cleaned_metrics$t1_neighbor_corr <- scale(cleaned_metrics$t1_neighbor_corr)
cleaned_metrics$brain_size <- scale(cleaned_metrics$brain_size)
cleaned_metrics$interview_age <- scale(cleaned_metrics$interview_age)
cleaned_metrics$sex <- scale(cleaned_metrics$sex)
```

```{r}
# ADD "+brain_size" to include brain_size in analysis
# Define a function to fit the model, with and without brain size
linear_with_size <- function(df) {
  lm(score ~ sex + interview_age + t1_neighbor_corr, data = df)}
```

```{r}
# Reduced model for partial r^2 analysis 
linear_reduced <- function(df) {
  lm(score ~ sex + t1_neighbor_corr, data = df)}
```

```{r}
# Group the dataframe by the 'bundles' column and apply the fit_model function
results <- cleaned_metrics %>%
  group_by(metric, bundle) %>%
  do(model = linear_with_size(.))
```

```{r}
# Reduced results (for r^2 analysis, excludes age term)
reduced_results <- cleaned_metrics %>%
  group_by(metric, bundle) %>%
  do(model = linear_reduced(.))
```

```{r}
# Ensure the models are of class 'lm'
summary(results$model[[1]])[["coefficients"]]["interview_age", "t value"]
```
```{r}
broom::tidy(results$model[[1]])
```

```{r}
results$tstat <- 0 
for(i in 1:nrow(results)) {
    results$tstat[i] = broom::tidy(results$model[[i]])  %>%
          filter(term == "interview_age") %>%
          pull(statistic)
}

```

```{r}
main_metrics <- c('area_of_end_region_1_mm2', 'area_of_end_region_2_mm2',
       'diameter_mm', 'dti_fa', 'md', 'mean_length_mm',
       'radius_of_end_region_1_mm', 'radius_of_end_region_2_mm', 
       'total_radius_of_end_regions_mm', 'total_surface_area_mm2',
       'trunk_volume_mm3',
       'volume_mm3')
results_main <- results %>%
  filter(metric %in% main_metrics)
```


```{r, fig.width=16, fig.height=8}
ggplot(results, aes(x = tstat, fill = metric)) +
    geom_density(alpha = 0.5) +  # Density plot with transparency
    geom_vline(xintercept = 0, color = "red") +
    facet_wrap(~ metric) +  # Create a separate plot for each unique value in bundle
    labs(title = "Distribution of t statistic for age in linear regression by metric",
         x = "t_stat",
         y = "Density") +
    theme_minimal() +
    theme(legend.position = "none")  # Remove legend for clarity if needed
```

Take the partial Rs

```{r}
# Calculate the partial R^2 for 'age'
results$partial_r2 <- 0
for(i in 1:nrow(results)) {
  full_r2 <- summary(results$model[[i]])$r.squared
  reduced_r2 <- summary(reduced_results$model[[i]])$r.squared
  results$partial_r2[[i]] <- (full_r2 - reduced_r2)/reduced_r2
}
```

```{r, fig.width=16, fig.height=8}
ggplot(results, aes(x = partial_r2, fill = metric)) +
    geom_density(alpha = 0.5) +  # Density plot with transparency
    geom_vline(xintercept = 0, color = "red") +  # Add vertical line at x = 0
    facet_wrap(~ metric) +  # Create a separate plot for each unique value in metric
    xlim(c(-1, 2)) +
    ylim(c(0, 5)) +
    labs(title = "Distribution of Partial R^2 for Age in Linear Regression by Metric",
         x = "Partial R^2",
         y = "Density") +
    theme_minimal() +
    theme(legend.position = "none")  # Remove legend for clarity if needed
```



